= pulumi-vsphere-vms

This repository contains a Pulumi component for quickly creating and managing vSphere virtual machines from a Linux template.

== Features

* Create multiple VMs from a single Linux template
* Automatic network configuration with static IP addresses
* Configurable CPU, memory, and disk settings per VM
* Support for different VM types (e.g., k8s-master, k8s-worker)
* Easy configuration through Pulumi YAML files

== Installation

Add this component to your Go project:

[source,bash]
----
go get github.com/BasisTI/pulumi-vsphere-vms
----

== Usage

=== Basic Usage

The component provides two ways to create VMs:

1. **Automatic configuration reading** (recommended):
+
[source,go]
----
import (
    "github.com/BasisTI/pulumi-vsphere-vms/vsphere-vms"
    "github.com/pulumi/pulumi/sdk/v3/go/pulumi"
)

func main() {
    pulumi.Run(func(ctx *pulumi.Context) error {
        // Create VMs using configuration from Pulumi YAML files
        vsphereVms, err := vsphere_vms.NewVsphereVmsFromConfig(ctx, "my-vms")
        if err != nil {
            return err
        }

        // Export VM IDs
        var vmIds []pulumi.StringOutput
        for _, vm := range vsphereVms.VirtualMachines {
            vmIds = append(vmIds, vm.ID().ToStringOutput())
        }
        ctx.Export("vmIds", pulumi.ToStringArrayOutput(vmIds))
        return nil
    })
}
----

2. **Manual configuration**:
+
[source,go]
----
args := &vsphere_vms.VsphereVmsArgs{
    Vms:        []vsphere_vms.VmData{...},
    VsphereCfg: vsphere_vms.VsphereCfg{...},
    NetworkCfg: vsphere_vms.NetworkCfg{...},
}
vsphereVms, err := vsphere_vms.NewVsphereVms(ctx, "my-vms", args)
----

== Configuration

When using `NewVsphereVmsFromConfig`, the component automatically reads three required configuration objects and one optional parameter from your Pulumi YAML files:

=== Optional Configuration Parameters

==== `makeAlias` - Resource Aliasing

[source,yaml]
----
makeAlias: true
----

.MakeAlias Parameter
[cols="1,1,3"]
|===
|Field |Type |Description

|`makeAlias`
|bool
|Optional. When set to `true`, creates Pulumi resource aliases for existing VMs. This is useful when refactoring existing projects to use this component, allowing Pulumi to recognize existing resources instead of trying to recreate them. Defaults to `false` if not specified.
|===

=== Required Configuration Objects

==== `vms` - Virtual Machines Configuration

Array of VM specifications:

[source,yaml]
----
vms:
  - name: "k8s-master-01"
    hostName: "k8s-master-01"
    ipv4address: "192.168.1.100"
    numCpus: 4
    memory: 8192
  - name: "k8s-worker-01"
    hostName: "k8s-worker-01"
    ipv4address: "192.168.1.101"
    numCpus: 2
    memory: 4096
----

.VM Configuration Fields
[cols="1,1,3"]
|===
|Field |Type |Description

|`name`
|string
|Name of the virtual machine in vSphere

|`hostName`
|string
|Hostname to be set in the guest OS

|`ipv4address`
|string
|Static IPv4 address for the VM

|`numCpus`
|int
|Number of CPU cores

|`memory`
|int
|Memory size in MB
|===

==== `vsphereCfg` - vSphere Environment Configuration

[source,yaml]
----
vsphereCfg:
  datacenter: "MyDatacenter"
  datastore: "datastore1"
  cluster: "MyCluster"
  networkName: "VM Network"
  templateName: "ubuntu-22.04-template"
  templateFolder: "templates"
  vmsFolder: "vms"
  enableLogging: true
  enableDiskUuid: true
  waitForGuestIpTimeout: 300    # Optional, defaults to 300 seconds
  waitForGuestNetTimeout: 300   # Optional, defaults to 300 seconds
----

.vSphere Configuration Fields
[cols="1,1,3"]
|===
|Field |Type |Description

|`datacenter`
|string
|vSphere datacenter name

|`datastore`
|string
|Target datastore for VM storage

|`cluster`
|string
|vSphere compute cluster name

|`networkName`
|string
|vSphere network/port group name

|`templateName`
|string
|Name of the Linux VM template to clone

|`templateFolder`
|string
|Folder containing the VM template

|`vmsFolder`
|string
|Target folder for new VMs

|`enableLogging`
|bool
|Enable VM logging

|`enableDiskUuid`
|bool
|Enable disk UUID for the VMs

|`waitForGuestIpTimeout`
|int
|Optional. Timeout in seconds for waiting for guest IP address. Defaults to 300 seconds if not specified.

|`waitForGuestNetTimeout`
|int
|Optional. Timeout in seconds for waiting for guest network to be ready. Defaults to 300 seconds if not specified.
|===

==== `networkCfg` - Network Configuration

[source,yaml]
----
networkCfg:
  gateway: "192.168.1.1"
  dnsServers:
    - "8.8.8.8"
    - "8.8.4.4"
  dnsSuffixes:
    - "local.domain"
  domain: "local.domain"
  mask: 24
----

.Network Configuration Fields
[cols="1,1,3"]
|===
|Field |Type |Description

|`gateway`
|string
|Network gateway IP address

|`dnsServers`
|[]string
|List of DNS server IP addresses

|`dnsSuffixes`
|[]string
|List of DNS search suffixes

|`domain`
|string
|Network domain name

|`mask`
|int
|Subnet mask in CIDR notation (e.g., 24 for /24)
|===

== Example Project

See the link:example/[example directory] for a complete working example that demonstrates:

* link:example/main.go[Main Go application]
* link:example/Pulumi.yaml[Root Pulumi configuration]
* link:example/Pulumi.example.yaml[Stack-specific configuration]
* link:example/go.mod[Go module setup]

The example creates a set of Kubernetes VMs (1 master + 2 workers) with proper network configuration.

== Prerequisites

* vSphere environment with appropriate permissions
* Linux VM template configured for cloning
* Pulumi CLI installed and configured
* Go 1.19 or later

== Template Requirements

Your Linux template should be configured with:

* VMware Tools installed
* Network configuration set to use DHCP (will be overridden by static config)
* Proper user account for post-deployment configuration
* Any required software pre-installed

== License

This project is licensed under the Apache License  Version 2.0 - see the link:LICENSE[LICENSE] file for details.
